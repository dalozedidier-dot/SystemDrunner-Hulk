name: ci

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 */6 * * *"

jobs:
  smoke_ddr_e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Debug layout
        shell: bash
        run: |
          set -euo pipefail
          echo "ROOT:"
          ls -la
          echo ""
          echo "Find harness.py:"
          find . -maxdepth 6 -type f -name "harness.py" -print || true
          echo ""
          echo "Find fixtures (md/csv):"
          find tests -maxdepth 6 -type f \( -name "*.md" -o -name "*.csv" \) -print || true

      - name: Run harness (aggregated)
        shell: bash
        env:
          PYTHONPATH: .
        run: |
          set +e
          rm -rf _ci_out
          mkdir -p _ci_out

          HARNESS=$(find . -maxdepth 6 -type f -name "harness.py" | head -n 1)
          if [ -z "$HARNESS" ]; then
            echo "No harness.py found" | tee _ci_out/smoke.log
            echo 2 > _ci_out/exit_code.txt
            exit 0
          fi

          echo "Using HARNESS=$HARNESS" | tee _ci_out/smoke.log
          python "$HARNESS" --help > _ci_out/harness_help.txt 2>&1

          OUT_JSON="_ci_out/harness_results.json"
          python "$HARNESS" --repo-root . --out "$OUT_JSON" 2>&1 | tee -a _ci_out/smoke.log
          echo $? > _ci_out/exit_code.txt

          exit 0

      - name: Export classic reports (ddr_report.json + e_report.json)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          from pathlib import Path

          out_dir = Path("_ci_out")
          p = out_dir / "harness_results.json"
          if not p.exists():
            (out_dir / "export_error.txt").write_text("Missing harness_results.json\n", encoding="utf-8")
            raise SystemExit(0)

          data = json.loads(p.read_text(encoding="utf-8"))
          if not isinstance(data, list) or not data:
            (out_dir / "export_error.txt").write_text("Empty harness_results.json\n", encoding="utf-8")
            raise SystemExit(0)

          first = data[0]

          ddr = first.get("ddr", {})
          extraction = first.get("extraction", {})
          meta = first.get("meta", {})

          # ddr_report.json (style historique)
          (out_dir / "ddr_report.json").write_text(
            json.dumps(ddr, indent=2, ensure_ascii=False),
            encoding="utf-8"
          )

          # e_report.json (style historique: E + listes)
          e_report = {
            "E": ddr.get("e", "INCONCLUSIF"),
            "ko": ddr.get("ko", []),
            "nc": ddr.get("nc", []),
            "ok": ddr.get("ok", []),
            "meta": {
              "profile_id": meta.get("profile_id"),
              "adapter_id": meta.get("adapter_id"),
              "kernel": meta.get("kernel"),
              "fixture": extraction.get("fixture"),
            }
          }
          (out_dir / "e_report.json").write_text(
            json.dumps(e_report, indent=2, ensure_ascii=False),
            encoding="utf-8"
          )

          # extraction_report.json (utile pour audit)
          (out_dir / "extraction_report.json").write_text(
            json.dumps(extraction, indent=2, ensure_ascii=False),
            encoding="utf-8"
          )

          # mini résumé
          summary = {
            "picked_index": 0,
            "total_cases": len(data),
            "picked_fixture": extraction.get("fixture"),
            "picked_profile": meta.get("profile_id"),
            "DDR": ddr.get("ddr"),
            "E": ddr.get("e"),
            "ko": ddr.get("ko", []),
            "nc": ddr.get("nc", []),
            "ok": ddr.get("ok", []),
          }
          (out_dir / "smoke_summary.json").write_text(
            json.dumps(summary, indent=2, ensure_ascii=False),
            encoding="utf-8"
          )
          PY

          echo "Produced:"
          ls -la _ci_out | sed -n '1,200p'

      - name: Write GitHub summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f _ci_out/smoke_summary.json ]; then
            python - <<'PY'
            import json, os
            from pathlib import Path
            s = json.loads(Path("_ci_out/smoke_summary.json").read_text(encoding="utf-8"))
            lines = []
            lines.append("# Systemd-runner smoke DDR + E")
            lines.append("")
            lines.append(f"Fixture: `{s.get('picked_fixture')}`")
            lines.append(f"Profile: `{s.get('picked_profile')}`")
            lines.append(f"DDR: `{s.get('DDR')}`")
            lines.append(f"E: `{s.get('E')}`")
            lines.append("")
            lines.append(f"KO: `{', '.join(s.get('ko') or [])}`")
            lines.append(f"NC: `{', '.join(s.get('nc') or [])}`")
            lines.append(f"OK: `{', '.join(s.get('ok') or [])}`")
            lines.append("")
            Path(os.environ["GITHUB_STEP_SUMMARY"]).write_text("\n".join(lines), encoding="utf-8")
            PY
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: systemd_runner_artifacts
          path: _ci_out/
          retention-days: 30
          if-no-files-found: error

      - name: Fail if harness failed
        shell: bash
        run: |
          set -euo pipefail
          code=$(cat _ci_out/exit_code.txt || echo 99)
          echo "exit_code=$code"
          if [ "$code" != "0" ]; then
            exit 1
          fi
