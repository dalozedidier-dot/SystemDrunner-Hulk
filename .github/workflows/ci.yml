name: ci

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 */6 * * *"

jobs:
  smoke_ddr_e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Debug layout
        shell: bash
        run: |
          set -euo pipefail
          echo "ROOT:"
          ls -la
          echo ""
          echo "test_data:"
          ls -la test_data || true
          echo ""
          echo "Find harness.py:"
          find . -maxdepth 6 -type f -name "harness.py" -print || true
          echo ""
          echo "Find band_*.csv:"
          find . -maxdepth 6 -type f -name "band_*.csv" -print || true

      - name: Run harness (DDR + E)
        shell: bash
        env:
          PYTHONPATH: .
        run: |
          set +e
          rm -rf _ci_out
          mkdir -p _ci_out

          # Trouver le harness automatiquement (au cas oÃ¹ le chemin bouge)
          HARNESS=$(find . -maxdepth 6 -type f -name "harness.py" | head -n 1)
          if [ -z "$HARNESS" ]; then
            echo "No harness.py found" | tee _ci_out/smoke.log
            echo 2 > _ci_out/exit_code.txt
            exit 0
          fi

          echo "Using HARNESS=$HARNESS" | tee _ci_out/smoke.log

          # Capturer l'aide pour qu'on voie les bons arguments
          python "$HARNESS" --help > _ci_out/harness_help.txt 2>&1

          OUT_JSON="_ci_out/harness_results.json"

          # Si le harness supporte --input-dir, on lui donne test_data
          if python "$HARNESS" --help 2>/dev/null | grep -q -- "--input-dir"; then
            python "$HARNESS" --repo-root . --input-dir test_data --out "$OUT_JSON" 2>&1 | tee -a _ci_out/smoke.log
            echo $? > _ci_out/exit_code.txt
          else
            # Sinon on tente un run minimal sans input-dir (smoke interne)
            python "$HARNESS" --repo-root . --out "$OUT_JSON" 2>&1 | tee -a _ci_out/smoke.log
            echo $? > _ci_out/exit_code.txt
          fi

          echo "" | tee -a _ci_out/smoke.log
          echo "Find produced reports (ddr_report.json / e_report.json):" | tee -a _ci_out/smoke.log
          find . -maxdepth 10 -type f \( -name "ddr_report.json" -o -name "e_report.json" \) -print | tee _ci_out/found_reports.txt || true

          exit 0

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: systemd_runner_artifacts
          path: |
            _ci_out/
            **/ddr_report.json
            **/e_report.json
          if-no-files-found: error

      - name: Fail if harness failed
        shell: bash
        run: |
          set -euo pipefail
          code=$(cat _ci_out/exit_code.txt || echo 99)
          echo "exit_code=$code"
          if [ "$code" != "0" ]; then
            exit 1
          fi
